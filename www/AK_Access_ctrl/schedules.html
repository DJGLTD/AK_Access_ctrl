<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Access Schedules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <style>:root{ --bg:#0b1320; --card:#111a2b; --border:#1b2942; --text:#e6edf3; --muted:#a5b5cc; } body{ background:var(--bg); color:var(--text);} .card{background:#111a2b;border:1px solid #1b2942}</style>
</head>
<body>
<script>
(function(){ const qs=new URLSearchParams(location.search); const t=qs.get('token'); if(t) sessionStorage.setItem('akuvox_ll_token',t); })();
const AUTH = ()=>{ const t=sessionStorage.getItem('akuvox_ll_token'); return t?{'Authorization':'Bearer '+t}:{}}; 
async function getState(){ const r=await fetch('/api/akuvox_ac/ui/state',{headers:AUTH()}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function action(act,payload){ const r=await fetch('/api/akuvox_ac/ui/action',{method:'POST',headers:{'Content-Type':'application/json',...AUTH()},body:JSON.stringify({action:act,payload})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

let SCHEDS={};
function row(day, idx, start='', end=''){
  return `<div class="row g-2 align-items-center mb-1" data-day="${day}" data-idx="${idx}">
    <div class="col-2 text-capitalize">${day}</div>
    <div class="col-4"><input class="form-control form-control-sm" placeholder="HH:MM" value="${start}"/></div>
    <div class="col-4"><input class="form-control form-control-sm" placeholder="HH:MM" value="${end}"/></div>
    <div class="col-2"><button class="btn btn-sm btn-outline-danger" onclick="removeRow('${day}',${idx})">Remove</button></div>
  </div>`;
}
function render(name){
  const container=document.getElementById('editor'); container.innerHTML='';
  const days=['mon','tue','wed','thu','fri','sat','sun'];
  days.forEach(d=>{
    const spans=(SCHEDS[name]&&SCHEDS[name][d])||[];
    if(!spans.length) container.insertAdjacentHTML('beforeend', row(d,0,'',''));
    else spans.forEach((sp,i)=>container.insertAdjacentHTML('beforeend',row(d,i,sp[0],sp[1])));
  });
}
function removeRow(day, idx){ const rows=[...document.querySelectorAll(`[data-day="${day}"]`)]; const row=rows[idx]; if(row) row.remove(); }
function addRow(day){ const rows=[...document.querySelectorAll(`[data-day="${day}"]`)]; const idx=rows.length; document.getElementById('editor').insertAdjacentHTML('beforeend', row(day, idx,'','')); }
async function save(){
  const name=document.getElementById('schedName').value.trim();
  if(!name){ alert('Enter a schedule name'); return; }
  if(name==='24/7 Access' || name==='No Access'){ alert('Built-in schedules are fixed. Create a custom schedule.'); return; }
  const out={}; const days=['mon','tue','wed','thu','fri','sat','sun'];
  days.forEach(d=>{ out[d]=[]; document.querySelectorAll(`[data-day="${d}"]`).forEach(div=>{ const ins=div.querySelectorAll('input'); const s=ins[0].value.trim(); const e=ins[1].value.trim(); if(s&&e) out[d].push([s,e]); }); });
  await action('upsert_schedule',{ name, spec: out });
  location.reload();
}
async function del(){
  const name=document.getElementById('schedName').value.trim();
  if(!name) return;
  if(name==='24/7 Access' || name==='No Access'){ alert('Built-in schedules cannot be deleted.'); return; }
  await action('delete_schedule',{ name });
  location.reload();
}
async function load(){
  const st=await getState(); SCHEDS=st.schedules||{};
  const sel=document.getElementById('schedSel'); 
  const names=Object.keys(SCHEDS);
  sel.innerHTML=names.map(n=>`<option>${n}</option>`).join('');
  sel.addEventListener('change', e=>{ document.getElementById('schedName').value=e.target.value; render(e.target.value); });
  if(names.length){
    sel.value = names[0];
    document.getElementById('schedName').value=sel.value; 
    render(sel.value);
  }
}
</script>
<div class="container py-3">
  <h2>Access Schedules</h2>
  <div class="card p-3">
    <div class="mb-2">
      <label class="form-label">Existing schedules</label>
      <select id="schedSel" class="form-select form-select-sm"></select>
    </div>
    <div class="mb-2"><label class="form-label">Schedule name</label><input id="schedName" class="form-control"/></div>
    <div id="editor"></div>
    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-success" onclick="save()">Save</button>
      <button class="btn btn-danger" onclick="del()">Delete</button>
      <a class="btn btn-secondary" href="/local/akuvox_ac/index.html">Back</a>
    </div>
  </div>
</div>
<script>load()</script>
</body>
</html>
