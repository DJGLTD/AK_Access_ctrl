<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Access Schedules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <style>:root{ --bg:#0b1320; --card:#111a2b; --border:#1b2942; --text:#e6edf3; --muted:#a5b5cc; } body{ background:var(--bg); color:var(--text);} .card{background:#111a2b;border:1px solid #1b2942}</style>
</head>
<body>
<script>
(function captureToken(){
  const qs = new URLSearchParams(location.search);
  const token = qs.get('token');
  if (token) sessionStorage.setItem('akuvox_ll_token', token);
})();

const UI_ROOT = '/akuvox-ac';
const SAME_ORIGIN = { credentials: 'same-origin' };
const REJECTED_TOKENS = new Set();

function findHaToken(){
  return sessionStorage.getItem('akuvox_ll_token') || null;
}

function nextBearerToken(){
  const token = findHaToken();
  if (!token) return null;
  if (REJECTED_TOKENS.has(token)) return null;
  return token;
}

async function fetchWithAuth(url, options = {}, { allowRetry = true } = {}){
  const originalHeaders = { ...(options.headers || {}) };
  let bearer = allowRetry ? nextBearerToken() : null;
  let usedBearer = !!bearer;
  const headers = { ...originalHeaders };
  if (bearer) headers['Authorization'] = 'Bearer ' + bearer;

  const response = await fetch(url, { ...SAME_ORIGIN, ...options, headers });

  if (allowRetry && usedBearer && (response.status === 401 || response.status === 403)){
    REJECTED_TOKENS.add(bearer);
    const retryToken = nextBearerToken();
    if (retryToken && retryToken !== bearer){
      return fetchWithAuth(url, { ...options, headers: originalHeaders }, { allowRetry: true });
    }
    return fetchWithAuth(url, { ...options, headers: originalHeaders }, { allowRetry: false });
  }

  return response;
}

function buildError(res, text){
  const message = `${res.status}: ${text || res.statusText || 'Request failed'}`;
  const err = new Error(message);
  err.status = res.status;
  err.body = text;
  return err;
}

function isAuthError(err){
  if (!err) return false;
  if (err.status === 401 || err.status === 403) return true;
  const msg = String(err.message || err || '').toLowerCase();
  return msg.includes('401') || msg.includes('403') || msg.includes('unauthor');
}

function buildHref(slug, params = {}){
  const search = new URLSearchParams();
  Object.entries(params || {}).forEach(([key, value]) => {
    if (value === undefined || value === null || value === '') return;
    search.set(key, value);
  });
  const token = findHaToken();
  if (token) search.set('token', token);
  const query = search.toString();
  const clean = String(slug || '').replace(/_/g, '-');
  return `${UI_ROOT}/${clean}${query ? `?${query}` : ''}`;
}

function requestParentNav(view, params = {}, options = {}){
  try {
    if (window.parent && window.parent !== window) {
      const msg = { type: 'akuvox-nav', view: String(view || ''), slug: String(view || ''), params };
      if (options.updateHistory === false) msg.updateHistory = false;
      if (options.replaceState) msg.replaceState = true;
      window.parent.postMessage(msg, window.location.origin);
      return true;
    }
  } catch (err) {}
  return false;
}

function redirectToUnauthorized(params = {}){
  try {
    const path = (window.location.pathname || '').toLowerCase();
    if (path.endsWith('/unauthorized') || path.endsWith('/unauthorized.html')) {
      return true;
    }
  } catch (err) {}

  const targetParams = params && typeof params === 'object' ? params : {};
  const href = buildHref('unauthorized', targetParams);
  const delivered = requestParentNav('unauthorized', targetParams, { replaceState: true });
  if (!delivered) {
    try { window.location.replace(href); }
    catch (err) { window.location.href = href; }
  }
  return true;
}

function handleAuthError(err){
  if (!isAuthError(err)) return false;
  redirectToUnauthorized();
  return true;
}

function collectSignedPaths(){
  const result = {};
  const merge = (candidate) => {
    if (!candidate || typeof candidate !== 'object') return;
    for (const [key, value] of Object.entries(candidate)) {
      if (typeof value === 'string' && value) result[key] = value;
    }
  };
  const read = (storage) => {
    if (!storage) return;
    try {
      const raw = storage.getItem('akuvox_signed_paths');
      if (raw) {
        const parsed = JSON.parse(raw);
        merge(parsed);
      }
    } catch (err) {}
  };

  try { merge(window.AK_AC_SIGNED_PATHS); } catch (err) {}
  try { read(typeof sessionStorage !== 'undefined' ? sessionStorage : null); } catch (err) {}
  try { read(typeof localStorage !== 'undefined' ? localStorage : null); } catch (err) {}

  try {
    if (window.parent && window.parent !== window) {
      try { merge(window.parent.AK_AC_SIGNED_PATHS); } catch (err) {}
      try { read(window.parent.sessionStorage); } catch (err) {}
      try { read(window.parent.localStorage); } catch (err) {}
    }
  } catch (err) {}

  return result;
}

const SIGNED_PATHS = collectSignedPaths();

function signedPath(key, fallback){
  if (SIGNED_PATHS && typeof SIGNED_PATHS[key] === 'string' && SIGNED_PATHS[key]) {
    return SIGNED_PATHS[key];
  }
  return fallback;
}

const API_STATE  = signedPath('state', '/api/akuvox_ac/ui/state');
const API_ACTION = signedPath('action', '/api/akuvox_ac/ui/action');

async function getState(){
  const res = await fetchWithAuth(API_STATE);
  if (!res.ok){
    const text = await res.text();
    const err = buildError(res, text);
    handleAuthError(err);
    throw err;
  }
  return res.json();
}

async function action(act, payload){
  const res = await fetchWithAuth(API_ACTION, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: act, payload })
  });
  if (!res.ok){
    const text = await res.text();
    const err = buildError(res, text);
    handleAuthError(err);
    throw err;
  }
  return res.json();
}

let SCHEDS = {};

function row(day, idx, start = '', end = ''){
  return `<div class="row g-2 align-items-center mb-1" data-day="${day}" data-idx="${idx}">
    <div class="col-2 text-capitalize">${day}</div>
    <div class="col-4"><input class="form-control form-control-sm" placeholder="HH:MM" value="${start}"/></div>
    <div class="col-4"><input class="form-control form-control-sm" placeholder="HH:MM" value="${end}"/></div>
    <div class="col-2"><button class="btn btn-sm btn-outline-danger" onclick="removeRow('${day}',${idx})">Remove</button></div>
  </div>`;
}

function render(name){
  const container = document.getElementById('editor');
  container.innerHTML = '';
  const days = ['mon','tue','wed','thu','fri','sat','sun'];
  days.forEach(day => {
    const spans = (SCHEDS[name] && SCHEDS[name][day]) || [];
    if (!spans.length) {
      container.insertAdjacentHTML('beforeend', row(day, 0, '', ''));
    } else {
      spans.forEach((span, idx) => container.insertAdjacentHTML('beforeend', row(day, idx, span[0], span[1])));
    }
  });
}

function removeRow(day, idx){
  const rows = [...document.querySelectorAll(`[data-day="${day}"]`)];
  const rowEl = rows[idx];
  if (rowEl) rowEl.remove();
}

function addRow(day){
  const rows = [...document.querySelectorAll(`[data-day="${day}"]`)];
  const idx = rows.length;
  document.getElementById('editor').insertAdjacentHTML('beforeend', row(day, idx, '', ''));
}

async function save(){
  const name = document.getElementById('schedName').value.trim();
  if (!name){ alert('Enter a schedule name'); return; }
  if (name === '24/7 Access' || name === 'No Access'){ alert('Built-in schedules are fixed. Create a custom schedule.'); return; }
  const out = {};
  const days = ['mon','tue','wed','thu','fri','sat','sun'];
  days.forEach(day => {
    out[day] = [];
    document.querySelectorAll(`[data-day="${day}"]`).forEach(div => {
      const inputs = div.querySelectorAll('input');
      const start = inputs[0].value.trim();
      const end = inputs[1].value.trim();
      if (start && end) out[day].push([start, end]);
    });
  });
  try {
    await action('upsert_schedule', { name, spec: out });
    location.reload();
  } catch (err) {
    if (handleAuthError(err)) return;
    alert('Failed to save schedule: ' + (err && err.message ? err.message : err));
  }
}

async function del(){
  const name = document.getElementById('schedName').value.trim();
  if (!name) return;
  if (name === '24/7 Access' || name === 'No Access'){ alert('Built-in schedules cannot be deleted.'); return; }
  try {
    await action('delete_schedule', { name });
    location.reload();
  } catch (err) {
    if (handleAuthError(err)) return;
    alert('Failed to delete schedule: ' + (err && err.message ? err.message : err));
  }
}

async function load(){
  try {
    const st = await getState();
    SCHEDS = st.schedules || {};
    const sel = document.getElementById('schedSel');
    const names = Object.keys(SCHEDS);
    sel.innerHTML = names.map(n => `<option>${n}</option>`).join('');
    sel.addEventListener('change', (e) => {
      document.getElementById('schedName').value = e.target.value;
      render(e.target.value);
    });
    if (names.length){
      sel.value = names[0];
      document.getElementById('schedName').value = sel.value;
      render(sel.value);
    } else {
      document.getElementById('schedName').value = '';
      document.getElementById('editor').innerHTML = '';
    }
  } catch (err) {
    if (handleAuthError(err)) return;
    alert('Failed to load schedules: ' + (err && err.message ? err.message : err));
  }
}
</script>
<div class="container py-3">
  <h2>Access Schedules</h2>
  <div class="card p-3">
    <div class="mb-2">
      <label class="form-label">Existing schedules</label>
      <select id="schedSel" class="form-select form-select-sm"></select>
    </div>
    <div class="mb-2"><label class="form-label">Schedule name</label><input id="schedName" class="form-control"/></div>
    <div id="editor"></div>
    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-success" onclick="save()">Save</button>
      <button class="btn btn-danger" onclick="del()">Delete</button>
      <a class="btn btn-secondary" href="/akuvox-ac/index">Back</a>
    </div>
  </div>
</div>
<script>load()</script>
</body>
</html>
