<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Akuvox User Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" crossorigin="anonymous" />
  <style>
    :root{ --bg:#0b1320; --card:#111a2b; --border:#1b2942; --text:#e6edf3; --muted:#a5b5cc; }
    body{ background:var(--bg); color:var(--text); font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .card{ background:#111a2b; border:1px solid #1b2942; }
    label{ color:#fff; }
    .muted{ color:var(--muted); }
    .btn-toggle{ width: 220px; }
    .uploader-hint { font-size: .9rem; color: var(--muted); }
    .form-text code { color: #c7dfff; }
  </style>
</head>
<body>
<script>
/* -------------------- auth + helpers -------------------- */
(function () {
  const qs = new URLSearchParams(location.search);
  const qsToken = qs.get('token');
  if (qsToken) sessionStorage.setItem('akuvox_ll_token', qsToken);
})();
function findHaToken(){
  const existing = sessionStorage.getItem('akuvox_ll_token');
  if (existing) return existing;

  const scan = (stor) => {
    if (!stor) return null;
    try {
      const direct = stor.getItem('hassTokens');
      if (direct) {
        const parsed = JSON.parse(direct);
        const token = parsed?.access_token || parsed?.token?.access_token || parsed?.data?.access_token;
        if (token) return token;
      }
      for (const key of Object.keys(stor)) {
        if (!/auth|token|hass/i.test(key)) continue;
        try {
          const candidate = JSON.parse(stor.getItem(key));
          const token = candidate?.access_token || candidate?.token?.access_token || candidate?.data?.access_token;
          if (token) return token;
        } catch (err) {}
      }
    } catch (err) {}
    return null;
  };

  let token = scan(sessionStorage) || scan(localStorage);
  if (token) {
    sessionStorage.setItem('akuvox_ll_token', token);
    return token;
  }

  try {
    if (window.parent && window.parent !== window && window.parent.origin === window.origin) {
      token = scan(window.parent.sessionStorage) || scan(window.parent.localStorage);
      if (token) {
        sessionStorage.setItem('akuvox_ll_token', token);
        return token;
      }
    }
  } catch (err) {}

  return null;
}
const SAME_ORIGIN = { credentials: 'same-origin' };
const REJECTED_TOKENS = new Set();

function nextBearerToken(){
  const token = findHaToken();
  if (!token) return null;
  if (REJECTED_TOKENS.has(token)) return null;
  return token;
}

async function fetchWithAuth(url, options = {}, { allowRetry = true } = {}){
  const originalHeaders = { ...(options.headers || {}) };
  let bearer = allowRetry ? nextBearerToken() : null;
  let usedBearer = !!bearer;
  const headers = { ...originalHeaders };
  if (bearer) headers['Authorization'] = 'Bearer ' + bearer;

  const response = await fetch(url, { ...SAME_ORIGIN, ...options, headers });

  if (allowRetry && usedBearer && (response.status === 401 || response.status === 403)){
    REJECTED_TOKENS.add(bearer);
    const retryToken = nextBearerToken();
    if (retryToken && retryToken !== bearer){
      return fetchWithAuth(url, { ...options, headers: originalHeaders }, { allowRetry: true });
    }
    return fetchWithAuth(url, { ...options, headers: originalHeaders }, { allowRetry: false });
  }

  return response;
}

function buildError(res, text){
  const message = `${res.status}: ${text || res.statusText || 'Request failed'}`;
  const err = new Error(message);
  err.status = res.status;
  err.body = text;
  return err;
}

function isAuthError(err){
  if (!err) return false;
  if (err.status === 401 || err.status === 403) return true;
  const msg = String(err.message || err || '').toLowerCase();
  return msg.includes('401') || msg.includes('403') || msg.includes('unauthor');
}

function redirectToUnauthorized(params = {}){
  try {
    const path = (window.location.pathname || '').toLowerCase();
    if (path.endsWith('/unauthorized') || path.endsWith('/unauthorized.html')) {
      return true;
    }
  } catch (err) {}

  const targetParams = params && typeof params === 'object' ? params : {};
  let href = '/akuvox-ac/unauthorized';
  try {
    href = buildHref('unauthorized', targetParams);
  } catch (err) {}

  let delivered = false;
  try {
    delivered = requestParentNav('unauthorized', targetParams, { replaceState: true });
  } catch (err) {}

  if (!delivered) {
    try { window.location.replace(href); }
    catch (err) { window.location.href = href; }
  }
  return true;
}

function handleAuthError(err){
  if (!isAuthError(err)) return false;
  redirectToUnauthorized();
  return true;
}

async function apiGet(url){
  const r = await fetchWithAuth(url);
  if (!r.ok){
    const text = await r.text();
    const err = buildError(r, text);
    handleAuthError(err);
    throw err;
  }
  return r.json();
}
async function apiPost(url, body){
  const r = await fetchWithAuth(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
  if (!r.ok){
    const text = await r.text();
    const err = buildError(r, text);
    handleAuthError(err);
    throw err;
  }
  return r.json();
}
const UI_ROOT = '/akuvox-ac';
function setBusy(yes){ document.getElementById('busy').style.display = yes ? 'inline-block':'none'; }

function buildHref(slug, params = {}) {
  const search = new URLSearchParams();
  Object.entries(params || {}).forEach(([key, value]) => {
    if (value === undefined || value === null || value === '') return;
    search.set(key, value);
  });
  const token = sessionStorage.getItem('akuvox_ll_token');
  if (token) search.set('token', token);
  const query = search.toString();
  const clean = String(slug || '').replace(/_/g, '-');
  return `${UI_ROOT}/${clean}${query ? `?${query}` : ''}`;
}

function requestParentNav(view, params = {}, options = {}) {
  try {
    if (window.parent && window.parent !== window) {
      const msg = {
        type: 'akuvox-nav',
        view: String(view || ''),
        slug: String(view || ''),
        params
      };
      if (options.updateHistory === false) msg.updateHistory = false;
      if (options.replaceState) msg.replaceState = true;
      window.parent.postMessage(msg, window.location.origin);
      return true;
    }
  } catch (err) {}
  return false;
}

function openInApp(view, params = {}, options = {}) {
  const href = buildHref(view, params);
  const delivered = requestParentNav(view, params, options);
  if (!delivered) {
    window.location.href = href;
  }
  return delivered;
}

/* -------------------- app state -------------------- */
let SCHEDULES = {};     // { name: weekSpec, ... }
let PHONES = [];        // [{service, name}, ...] from /api/akuvox_ac/ui/phones
let REGISTRY = [];      // UI list of known users from /ui/state
let CURRENT = null;     // working user object
let RESERVED_ID = null; // HA### id reserved for new-user workflow

let reservationTimer = null;
let reservationMisses = 0;
let reservationHeartbeatBusy = false;

function setReservationMessage(html, tone = 'muted') {
  const el = document.getElementById('localHelp');
  if (!el) return;
  if (!html) {
    el.innerHTML = '';
    return;
  }
  const cls = tone === 'error' ? 'text-danger' : tone === 'warning' ? 'text-warning' : 'muted';
  el.innerHTML = `<span class="${cls}">${html}</span>`;
}

function stopReservationHeartbeat() {
  if (reservationTimer) {
    clearInterval(reservationTimer);
    reservationTimer = null;
  }
  reservationHeartbeatBusy = false;
  reservationMisses = 0;
}

async function heartbeatTick() {
  if (!RESERVED_ID || reservationHeartbeatBusy) return;
  reservationHeartbeatBusy = true;
  try {
    const res = await fetchWithAuth('/api/akuvox_ac/ui/reservation_ping', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: RESERVED_ID })
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'ping failed');
    if (data.active === false) {
      setReservationMessage('Reserved ID expired. Requesting a new ID…', 'warning');
      RESERVED_ID = null;
      stopReservationHeartbeat();
      const newId = await reserveNewId({ showWarning: true });
      if (newId && CURRENT) CURRENT.id = newId;
      return;
    }
    reservationMisses = 0;
  } catch (err) {
    if (handleAuthError(err)) return;
    reservationMisses += 1;
    if (reservationMisses >= 6) {
      setReservationMessage('Connection lost. Releasing reserved ID and trying again…', 'warning');
      try { await releaseReservation({ keepalive: true }); } catch (e) {}
      RESERVED_ID = null;
      stopReservationHeartbeat();
      const newId = await reserveNewId({ showWarning: true });
      if (newId && CURRENT) CURRENT.id = newId;
    }
  } finally {
    reservationHeartbeatBusy = false;
  }
}

function startReservationHeartbeat() {
  stopReservationHeartbeat();
  if (!RESERVED_ID) return;
  reservationTimer = setInterval(heartbeatTick, 10000);
}

async function reserveNewId(options = {}) {
  const idRow = document.getElementById('idRow');
  const input = document.getElementById('user_id');
  if (input) input.value = '';
  if (idRow) idRow.style.display = 'none';
  stopReservationHeartbeat();
  try {
    const res = await apiGet('/api/akuvox_ac/ui/reserve_id');
    const newId = res && res.ok && res.id ? res.id : '';
    if (!newId) throw new Error('reserve failed');
    RESERVED_ID = newId;
    if (input) input.value = newId;
    if (idRow) idRow.style.display = 'block';
    setReservationMessage('');
    startReservationHeartbeat();
    return newId;
  } catch (err) {
    RESERVED_ID = null;
    if (handleAuthError(err)) return '';
    if (options.showWarning !== false) {
      setReservationMessage('ID reserve failed. You can still press <b>Save</b> to create a user, then return to upload a face.', 'warning');
    }
    return '';
  }
}

// ---------- schedule id mapping helpers ----------
let SCHED_MAP = []; // [{id:"1001", name:"24/7 Access", label:"24/7 Access"}, ...]

function blankProfile(id = ''){
  return {
    id,
    name: '',
    groups: ['Default'],
    pin: '',
    phone: '',
    schedule_name: '24/7 Access',
    schedule_id: '1001',
    key_holder: false,
    access_level: ''
  };
}

function buildScheduleMap(){
  // Built-ins first
  const out = [
    { id: '1001', name: '24/7 Access', label: '24/7 Access' },
    { id: '1002', name: 'No Access',   label: 'No Access' }
  ];
  // Custom schedules (deterministic IDs: 1003+)
  const customNames = Object.keys(SCHEDULES || {})
    .filter(n => n !== '24/7 Access' && n !== 'No Access')
    .sort((a,b) => a.localeCompare(b));
  const base = 1003;
  customNames.forEach((name, i) => {
    const id = String(base + i);
    out.push({ id, name, label: name });
  });
  SCHED_MAP = out;
}
function optionLabel(item){ return `${item.id} - ${item.label}`; }
function nameForId(id){
  const x = SCHED_MAP.find(s => s.id === String(id));
  return x ? x.name : '24/7 Access';
}
function idForName(name){
  const lower = String(name || '').toLowerCase();
  if (lower === '24/7 access' || lower === '24/7') return '1001';
  if (lower === 'no access' || lower === 'never')  return '1002';
  const x = SCHED_MAP.find(s => s.name.toLowerCase() === lower);
  return x ? x.id : '1001';
}

async function releaseReservation(options = {}){
  if (!RESERVED_ID) return;
  const id = RESERVED_ID;
  RESERVED_ID = null;
  stopReservationHeartbeat();
  const payload = JSON.stringify({ id });
  if (options.keepalive && navigator.sendBeacon) {
    try {
      const blob = new Blob([payload], { type: 'application/json' });
      const ok = navigator.sendBeacon('/api/akuvox_ac/ui/release_id', blob);
      if (ok) return;
    } catch (err) {}
  }
  try {
    await fetchWithAuth('/api/akuvox_ac/ui/release_id', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: payload,
      keepalive: !!options.keepalive
    });
  } catch (err) {}
}

window.addEventListener('beforeunload', () => {
  if (RESERVED_ID) {
    stopReservationHeartbeat();
    releaseReservation({ keepalive: true });
  }
});

/* -------------------- load -------------------- */
async function load(){
  setBusy(true);
  try{
    let state;
    try {
      state = await apiGet('/api/akuvox_ac/ui/state');
    } catch (err) {
      if (handleAuthError(err)) return;
      console.warn('Failed to load Akuvox state', err);
      alert('Failed to load Akuvox data. Default values will be used until the connection succeeds.');
      state = { schedules: {}, registry_users: [] };
    }
    SCHEDULES = state.schedules || {};
    REGISTRY = state.registry_users || [];

    // Load phones (notify services from HA mobile app)
    try {
      const resp = await apiGet('/api/akuvox_ac/ui/phones');
      PHONES = resp.phones || [];
    } catch (err) {
      if (handleAuthError(err)) return;
      console.warn('Failed to load phone list', err);
      PHONES = [];
    }

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    if (id){
      // Edit existing
      const existing = REGISTRY.find(u => u.id === id);
      if (existing){
        CURRENT = {
          ...blankProfile(existing.id),
          ...existing,
          groups: Array.isArray(existing.groups) ? [...existing.groups] : ['Default'],
        };
        if (!CURRENT.schedule_id && CURRENT.schedule_name){
          CURRENT.schedule_id = idForName(CURRENT.schedule_name);
        }
      } else {
        CURRENT = blankProfile(id);
      }
      RESERVED_ID = null;
      stopReservationHeartbeat();
      setReservationMessage('');
      document.getElementById('title').textContent = 'Edit User';
      document.getElementById('idRow').style.display = 'block';
      document.getElementById('user_id').value = CURRENT.id;
    }else{
      // Add new — reserve an ID up-front so we can upload the face on Save
      document.getElementById('title').textContent = 'Add User';
      RESERVED_ID = null;
      CURRENT = blankProfile('');
      const newId = await reserveNewId();
      if (newId) {
        CURRENT.id = newId;
        CURRENT.schedule_id = '1001';
      } else {
        document.getElementById('idRow').style.display = 'none';
      }
    }
    fillForm();
    fillPhones();
  } finally {
    setBusy(false);
  }
}

function scheduleOptionsHtml(){
  buildScheduleMap();
  return SCHED_MAP.map(it => `<option value="${it.id}">${optionLabel(it)}</option>`).join('');
}

function fillForm(){
  document.getElementById('name').value = CURRENT.name || '';
  document.getElementById('pin').value = CURRENT.pin || '';
  document.getElementById('phone').value = CURRENT.phone || '';

  // Build schedule select with ids
  document.getElementById('schedule').innerHTML = scheduleOptionsHtml();
  const selEl = document.getElementById('schedule');
  const ids = new Set(Array.from(selEl.options).map(opt => opt.value));
  let selectedId = CURRENT.schedule_id ? String(CURRENT.schedule_id) : '';
  if (!selectedId || !ids.has(selectedId)) {
    selectedId = idForName(CURRENT.schedule_name || '24/7 Access');
  }
  if (!ids.has(selectedId)) {
    selectedId = '1001';
  }
  selEl.value = selectedId;
  CURRENT.schedule_id = selectedId;
  CURRENT.schedule_name = nameForId(selectedId);

  document.getElementById('key_holder').checked = !!CURRENT.key_holder;

  const localHelp = document.getElementById('localHelp');
  if (localHelp && !localHelp.innerHTML){
    if (CURRENT.id){
      localHelp.innerHTML = `<span class="muted">If you select a photo, it will be saved as <code>/api/AK_AC/FaceData/${CURRENT.id}.jpg</code> when you press <b>Save</b>.</span>`;
    } else {
      localHelp.innerHTML = `<span class="muted">ID reserve failed. You can still press <b>Save</b> to create a user, then return to upload a face.</span>`;
    }
  }
}

// Populate the Remote Enrolment dropdown with HA phone notify services
function fillPhones(){
  const sel = document.getElementById('device');  // keeping id=device for layout compatibility
  sel.innerHTML = '';
  if (!PHONES.length){
    sel.innerHTML = `<option value="" disabled selected>(no phones found)</option>`;
    sel.disabled = true;
  }else{
    sel.disabled = false;
    const sorted = [...PHONES].sort((a,b) => (a.name || a.service || '').localeCompare(b.name || b.service || ''));
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Select phone…';
    placeholder.disabled = true;
    placeholder.selected = true;
    sel.appendChild(placeholder);
    sorted.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.service;            // e.g. "mobile_app_johns_iphone"
      opt.textContent = p.name || p.service;
      sel.appendChild(opt);
    });
  }
  const resSpan = document.getElementById('remoteResult');
  if (resSpan) resSpan.textContent = '';
}

/* -------------------- save: user core + optional face upload + optional remote enrol -------------------- */
async function save(){
  if (!CURRENT){
    alert('Form not ready yet. Please reload the page.');
    return;
  }
  setBusy(true);
  try{
    // Ensure we have or reserve an ID
    if (!CURRENT.id){
      try{
        const res = await apiGet('/api/akuvox_ac/ui/reserve_id');
        if (res && res.ok && res.id) {
          CURRENT.id = res.id;
          RESERVED_ID = CURRENT.id;
          document.getElementById('idRow').style.display = 'block';
          document.getElementById('user_id').value = CURRENT.id;
        }
      }catch(err){
        if (handleAuthError(err)) return;
      }
      if (!CURRENT.id){
        alert('Could not reserve a user ID. Please try again.');
        return;
      }
    }

    const selectedScheduleId = document.getElementById('schedule').value || '1001';
    const selectedScheduleName = nameForId(selectedScheduleId);

    const payload = {
      name: document.getElementById('name').value.trim(),
      groups: CURRENT.groups || ['Default'],
      pin: document.getElementById('pin').value.trim() || undefined,
      phone: document.getElementById('phone').value.trim() || undefined,
      schedule_id: selectedScheduleId,          // drives ScheduleRelay on backend
      schedule_name: selectedScheduleName,      // for UI/state clarity
      key_holder: document.getElementById('key_holder').checked,
    };

    // Save/update the profile against the reserved ID
    const saveRes = await fetchWithAuth('/api/services/akuvox_ac/edit_user', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id: CURRENT.id, ...payload })
    });
    if (!saveRes.ok){
      const txt = await saveRes.text();
      const err = buildError(saveRes, txt);
      handleAuthError(err);
      throw err;
    }
    try { await saveRes.json(); } catch {}

    // If a photo is selected, upload it now
    const fileInput = document.getElementById('facefile');
    if (fileInput.files && fileInput.files[0]){
      const fd = new FormData();
      fd.append('id', CURRENT.id);
      fd.append('file', fileInput.files[0]);
      const r = await fetchWithAuth('/api/akuvox_ac/ui/upload_face', {
        method: 'POST',
        body: fd
      });
      if (!r.ok){
        const t = await r.text();
        const err = buildError(r, t);
        handleAuthError(err);
        throw err;
      }
      try { await r.json(); } catch {}
    }

    // If Remote panel is visible and a phone is selected, auto-send enrolment request now
    const remoteVisible = document.getElementById('pRemote').style.display !== 'none';
    const phoneSel = document.getElementById('device');
    const phoneService = phoneSel && phoneSel.value ? phoneSel.value : '';
    if (remoteVisible && phoneService){
      try{
        await apiPost('/api/akuvox_ac/ui/remote_enrol', { id: CURRENT.id, phone_service: phoneService });
        const resSpan = document.getElementById('remoteResult');
        if (resSpan) resSpan.textContent = 'Enrolment request sent.';
      }catch(e){
        if (handleAuthError(e)) return;
        const resSpan = document.getElementById('remoteResult');
        if (resSpan) resSpan.textContent = 'Failed to send enrolment request.';
      }
    }

    // Back to list
    stopReservationHeartbeat();
    RESERVED_ID = null;
    openInApp('index', {}, { replaceState: true });
  } catch (e){
    if (handleAuthError(e)) return;
    alert('Save failed: ' + (e && e.message ? e.message : e));
  } finally {
    setBusy(false);
  }
}

/* -------------------- toggle panels -------------------- */
async function cancelEdit(evt){
  if (evt) evt.preventDefault();
  stopReservationHeartbeat();
  await releaseReservation();
  openInApp('index', {}, { replaceState: true });
}

function showPanel(which){
  document.getElementById('pLocal').style.display = which === 'local' ? 'block':'none';
  document.getElementById('pRemote').style.display = which === 'remote' ? 'block':'none';
}
</script>

<div class="container py-3">
  <div class="d-flex align-items-center gap-2">
    <h2 id="title" class="m-0">User</h2>
    <span id="busy" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display:none;"></span>
  </div>

  <div class="card p-3 mt-3">
    <div id="idRow" class="mb-3" style="display:none;">
      <label class="form-label">User ID</label>
      <input id="user_id" class="form-control" readonly />
      <div class="form-text muted">ID is reserved locally so your selected photo can upload when you press <b>Save</b>.</div>
    </div>

    <div class="mb-3"><label class="form-label">Name</label><input id="name" class="form-control"/></div>

    <div class="mb-3">
      <label class="form-label">PIN</label>
      <div class="input-group">
        <input id="pin" class="form-control"/>
        <button class="btn btn-outline-secondary" onclick="document.getElementById('pin').value = String(Math.floor(1000+Math.random()*9000))">Random</button>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Face Recognition</label>
      <div class="d-flex gap-2 mb-2">
        <button class="btn btn-outline-light btn-toggle" onclick="showPanel('local')"><i class="bi bi-upload me-1"></i>Local enrolment</button>
        <button class="btn btn-outline-light btn-toggle" onclick="showPanel('remote')"><i class="bi bi-wifi me-1"></i>Remote enrolment</button>
      </div>
    </div>

    <!-- Local enrolment panel -->
    <div id="pLocal" class="mt-2" style="display:none;">
      <div class="mb-2" id="localHelp"></div>
      <div class="mb-2">
        <input id="facefile" class="form-control" type="file" accept=".jpg,image/jpeg" />
        <div class="uploader-hint mt-1">Choose a clear, front-facing JPG photo. It will be uploaded when you press <b>Save</b>.</div>
      </div>
    </div>

    <!-- Remote enrolment panel -->
    <div id="pRemote" class="mt-2" style="display:none;">
      <div class="mb-2 muted">Choose a phone (Home Assistant app) to receive an enrolment prompt:</div>
      <div class="row g-2 align-items-end">
        <div class="col-sm-6">
          <label class="form-label">Phone</label>
          <select id="device" class="form-select"></select>
        </div>
      </div>
      <div class="mt-2 muted" id="remoteResult"></div>
    </div>

    <div class="mb-3"><label class="form-label">Phone</label><input id="phone" class="form-control"/></div>

    <div class="mb-3">
      <label class="form-label">Access Schedule</label>
      <select id="schedule" class="form-select"></select>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="key_holder">
      <label class="form-check-label" for="key_holder">Key Holder (Disarm alarm and permit entry)</label>
    </div>

    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-success" onclick="save()"><i class="bi bi-check2-circle me-1"></i>Save</button>
      <a class="btn btn-secondary" href="#" onclick="cancelEdit(event)"><i class="bi bi-x-circle me-1"></i>Cancel</a>
    </div>

    <hr class="my-3"/>
  </div>
</div>
<script>load()</script>
</body>
</html>
